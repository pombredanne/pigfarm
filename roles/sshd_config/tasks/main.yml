---
- name: Include group secrets for sshd_config
  include_vars: secrets/group_vars/all.yml
  tags:
    - base

- name: Check if there are any hosts secrets
  stat: path="secrets/host_vars/{{ ansible_hostname  }}.yml"
  register: host_secrets_exist
  tags:
    - base

- name: Include host secrets
  include_vars: "secrets/host_vars/{{ ansible_hostname }}.yml"
  tags:
    - secret
    - users
  when: host_secrets_exist.stat.exists == True
  tags:
    - base

- name: upload sshd configuration
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    mode: 0600
    owner: root
    group: root
  notify: restart sshd
  tags:
    - base

- name: create sftp user and shared folder
  user:
    name: sftp
    home: /home/shared/sftp/
    createhome: yes
    password: "{{ sftp_server_pass }}"
    shell: /usr/sbin/nologin
    state: present
    uid: 1005
  when: >
    ansible_hostname in feature_sets and feature_sets[ansible_hostname]['sftp_server'] or
    feature_sets['default']['sftp_server']
  tags:
    - base

- name: Add users to sftp group
  user:
    name: "{{ item }}"
    group: sftp
  with_items: users.keys()
  when: sshd_config_sftp_server_enabled == true
