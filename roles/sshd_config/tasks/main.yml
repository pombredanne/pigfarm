---
- name: Include group secrets for sshd_config
  include_vars: secrets/group_vars/all

- name: Include host secrets for sshd_config
  include_vars: "secrets/host_vars/{{ ansible_hostname }}.yml"

- name: upload sshd configuration
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    mode: 0600
    owner: root
    group: root
  notify: restart sshd
  tags:
    - base
    - net

- name: create sftp user and shared folder
  user:
    name: sftp
    home: /home/shared/sftp/
    createhome: yes
    password: "{{ sftp_server_pass }}"
    shell: /usr/sbin/nologin
    state: present
    uid: 1005
  when: >
    ansible_hostname in feature_sets and feature_sets[ansible_hostname]['sftp_server'] or
    feature_sets['default']['sftp_server']
