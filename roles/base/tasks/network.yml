---
# On RHEL/CentOS7, rpm removal does not stop the service and after removing the rpm
# we cannot stop the service. OTOH later there is no NetworkManger script and
# service module fails. So we first test if rpm package is present.
- name: Check if NetworkManager is installed
  command:
    rpm -q NetworkManager
  ignore_errors: True
  register: _rpm_nm_out
  when: ansible_os_family == 'RedHat'
  changed_when: False

- name: Stop the Network Manager
  service:
    name: NetworkManager
    state: stopped
    enabled: false
  when: ansible_os_family == 'RedHat' and _rpm_nm_out is defined and _rpm_nm_out.rc == 0

- name: Remove Network Manager
  yum:
    name: NetworkManager
    state: absent
  when: ansible_os_family == 'RedHat' and _rpm_nm_out is defined and _rpm_nm_out.rc == 0

- name: Make ip configuration static instead of DHCP (RHEL/CentOS)
  template:
    src: ifcfg-eth0.centos.j2
    dest: /etc/sysconfig/network-scripts/ifcfg-eth0
    mode: 0644
    owner: root
    group: root
  notify: "restart RHEL/CentOS networking"
  when: ansible_os_family == 'RedHat'

- name: Configure auxilary interface for materpigs (RHEL/CentOS)
  template:
    src: ifcfg-eth1.centos.j2
    dest: /etc/sysconfig/network-scripts/ifcfg-eth1
    mode: 0644
    owner: root
    group: root
  notify: "restart RHEL/CentOS networking"
  when: ansible_os_family == 'RedHat' and inventory_hostname in groups['pxeservers']

- name: Create networking configuration snippets dir (Debian)
  file:
    path: /etc/network/interfaces.d/
    state: directory
    mode: 0750
    owner: root
    group: root
  notify: "restart Debian networking"
  when: ansible_os_family == 'Debian'

- name: Upload lo network configuration snippet (Debian)
  copy:
    src: interfaces.lo.debian
    dest: /etc/network/interfaces.d/interfaces.lo
    mode: 0644
    owner: root
    group: root
  notify: "restart Debian networking"
  when: ansible_os_family == 'Debian'

- name: Upload eth0 network configuration snippet (Debian)
  template:
    src: interfaces.eth0.debian.j2
    dest: /etc/network/interfaces.d/interfaces.eth0
    mode: 0644
    owner: root
    group: root
  notify: "restart Debian networking"
  when: ansible_os_family == 'Debian'

- name: Upload resolv.conf configuration
  template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: 0644
    owner: root
    group: root
