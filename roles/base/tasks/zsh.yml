---
- name: Install zsh shell (Debian)
  apt:
    name: zsh
    state: present
  when: ansible_os_family == 'Debian'

- name: Install zsh shell (CentOS)
  yum:
    name: zsh
    state: present
  when: ansible_os_family == 'RedHat'

- name: Clone oh-my-zsh repo
  git:
   repo: https://github.com/robbyrussell/oh-my-zsh.git
   dest: "/{{ item if item == 'root' else 'home/' + item }}/.oh-my-zsh/"
  with_items: users.keys()
  when: users[item]['shell'] == '/bin/zsh'

- name: Upload zshrc file
  copy:
    src: zshrc
    dest: "/{{ item if item == 'root' else 'home/' + item }}/.zshrc"
    mode: 0640
    owner: "{{ item }}"
    group: "{{ item }}"
  with_items: users.keys()
  when: users[item]['shell'] == '/bin/zsh'

- name: Upload custom oh-my-zsh theme
  copy:
    src: vesclean.zsh-theme
    dest: "/{{ item if item == 'root' else 'home/' + item }}/.oh-my-zsh/themes/vesclean.zsh-theme"
    mode: 0640
    owner: "{{ item }}"
    group: "{{ item }}"
  with_items: users.keys()
  when: users[item]['shell'] == '/bin/zsh'

- name: Set users shell
  user:
    name: '{{ item.key }}'
    shell: '{{ item.value.shell }}'
  with_dict: users
